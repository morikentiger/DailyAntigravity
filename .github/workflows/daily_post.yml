name: DailyAG Auto Post

on:
  push:
    paths:
      - 'Day*/**/*.md'

jobs:
  post:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-post')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install atproto python-frontmatter

      - name: Parse and Post
        shell: python
        env:
          BSKY_IDENTIFIER: ${{ secrets.BSKY_IDENTIFIER }}
          BSKY_PASSWORD: ${{ secrets.BSKY_PASSWORD }}
        run: |
          import os
          import re
          import frontmatter
          from atproto import Client, models

          def post_to_bsky():
              # Find all .md files (Log.md) in the structure
              files = []
              for root, _, f_names in os.walk('.'):
                  if 'Day' in root and '.gemini' not in root:
                      for f in f_names:
                          if f.endswith('.md'):
                              files.append(os.path.join(root, f))

              if not files:
                  print("No .md files found.")
                  return

              # In CI, mtime can be unreliable. Let's print all found files and their statuses.
              print(f"Found {len(files)} files: {files}")

              # Instead of just the latest by mtime, let's find the most recent one that says 'OK_TO_POST: yes'
              target_files = []
              for path in files:
                  try:
                      with open(path, 'r') as f:
                          if 'OK_TO_POST: yes' in f.read():
                              target_files.append(path)
                  except:
                      continue

              if not target_files:
                  print("No files marked with 'OK_TO_POST: yes' found.")
                  return

              # Still use mtime among target files
              latest_file = max(target_files, key=os.path.getmtime)
              print(f"Targeting: {latest_file}")

              with open(latest_file, 'r') as f:
                  content = f.read()

              # Extract POST section with more robust regex
              post_match = re.search(r'##\s*POST\s*\n(.*?)\n##', content, re.DOTALL | re.IGNORECASE)
              if not post_match:
                  # Fallback if it's the last section before EOF or something
                  post_match = re.search(r'##\s*POST\s*\n(.*?)$', content, re.DOTALL | re.IGNORECASE)

              if not post_match:
                  print("Could not parse POST section.")
                  return

              post_text = post_match.group(1).split('##')[0].strip()
              print(f"Post text extracted: {post_text[:50]}...")

              # Extract media from ARTIFACTS
              # Look for Screenshot, スクリーンショット, Video, or 動画
              media_match = re.search(r'-\s*(?:スクリーンショット|Screenshot|動画|Video)：\s*(.*?)(?:\n|$)', content, re.IGNORECASE)
              images = []
              if media_match:
                  media_paths = [p.strip() for p in media_match.group(1).split(',')]
                  log_dir = os.path.dirname(latest_file)
                  for img_path in img_paths:
                      full_img_path = os.path.join(log_dir, img_path)
                      if os.path.exists(full_img_path):
                          print(f"Found image: {full_img_path}")
                          images.append(full_img_path)
                      else:
                          print(f"Image path not found: {full_img_path}")

              print("Logging in to Bluesky...")
              client = Client()
              client.login(os.environ['BSKY_IDENTIFIER'], os.environ['BSKY_PASSWORD'])

              embed = None
              if images:
                  blobs = []
                  for img in images[:4]:
                      with open(img, 'rb') as f:
                          img_data = f.read()
                          resp = client.upload_blob(img_data)
                          blobs.append(models.AppBskyEmbedImages.Image(alt='DailyAG Artifact', image=resp.blob))
                  embed = models.AppBskyEmbedImages.Main(images=blobs)
                  print(f"Uploaded {len(blobs)} images.")

              root_post = client.send_post(text=post_text, embed=embed)
              print(f"Successfully posted to Bluesky! URI: {root_post.uri}")

          if __name__ == "__main__":
              post_to_bsky()
